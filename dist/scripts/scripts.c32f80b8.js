"use strict";angular.module("diancanApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ngSocket","ngStorage"]).config(["$routeProvider",function(a){a.when("/main",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"loginCtrl"}).otherwise({redirectTo:"/login"})}]),angular.module("diancanApp").controller("header-nav",["$rootScope","$scope","$location","$http","$sessionStorage",function(a,b,c,d,e){b.logined=!1,b.message="",a.safeApply=function(a){var b=this.$root.$$phase;"$apply"===b||"$digest"===b?a&&a():this.$apply(a)},b.$on("summon",function(a,d){"main"===d?(angular.element(".business-mng").addClass("active"),angular.element(".setting-page").removeClass("active")):"set"===d?(angular.element(".setting-page").addClass("active"),angular.element(".business-mng").removeClass("active")):"login"===d&&"0"!==b.$storage.accountId&&(c.path("/main"),b.logined=!0)}),b.printAskflag=0,b.printmenuING=0,b.printmenupicING=0,b.$on("printmenu",function(a,c){"continue"===c?b.$broadcast("printmenuAsk",0):1===b.printmenupicING?b.$broadcast("printmenuAsk",0):(b.printmenuING=1,colgarJS.messsage(c))}),b.$on("printmenuprice",function(a,c){b.printmenupicING=1,colgarJS.messsage(c)}),b.tiaoshiyong="",b.printBackMsg=function(a){b.tiaoshiyong="msg:"+a+"printmenuING:"+b.printmenuING,"suc"===a?1===b.printmenuING?(b.printmenuING=0,b.$broadcast("printmenuAsk",1)):1===b.printmenupicING&&(b.printmenupicING=0,b.$broadcast("printpicAsk",1)):(b.printAskflag=1,angular.element("#askmsg-show").modal("show"))},b.goAhead=function(){1===b.printAskflag&&(b.printAskflag=0,1===b.printmenuING?(b.printmenuING=0,b.$broadcast("printmenuAsk",0)):1===b.printmenupicING&&(b.printmenupicING=0,b.$broadcast("printpicAsk",0)))},b.$on("showmsg",function(a,c){b.message=c,angular.element(".msg-show").slideDown("normal"),setTimeout(function(){angular.element(".msg-show").slideUp("normal")},3e3)}),b.testconnect=function(){b.printmenupicING=0,b.$broadcast("printmenuAsk",0)},b.$storage=e.$default({accountId:"0",name:""}),a.accountId=b.$storage.accountId,b.$on("logindata",function(e,f){d.post("/adyd/web/merchant_login!login.do?account="+f.account+"&password="+f.password).success(function(d){"error"!==d.flag&&(c.path("/main"),b.logined=!0,b.$storage.accountId=d.data.merchantId,b.$storage.name=d.data.name,a.accountId=b.$storage.accountId)})}),"0"===b.$storage.accountId?(c.path("/login"),b.logined=!1):b.logined=!0}]),angular.module("diancanApp").controller("MainCtrl",["$rootScope","$scope","$http",function(a,b,c){function d(){c.post("/adyd/web/polling!getInfo.do?storeId="+a.accountId).success(function(a){if("success"===a.flag&&void 0!==a.datamsg&&null!==a.datamsg&&a.datamsg.length>0)for(var b=0;b<a.datamsg.length;b++)h(a.datamsg[b].n_tableId,!0)}),setTimeout(function(){d()},6e3)}function e(){c.post("/adyd/web/polling!getPrintOrder.do?storeId="+a.accountId).success(function(a){if("success"===a.flag&&void 0!==a.data&&null!==a.data&&0!==a.data.length){for(var c=""+a.tableNum+"\n",d=0;d<a.data.length;d++)c+=""+a.data[d].dishesName+"	"+a.data[d].count+"份\n";b.currentPrintMenu=a.data,b.$emit("printmenu",c)}else b.$emit("printmenu","continue")})}function f(a){c.post("/adyd/web/index!changeOrderItemStatus.do?content="+JSON.stringify(a)).success(function(a){"success"===a.flag?angular.noop():b.$emit("showmsg","后台操作出错")})}function g(a,c){for(var d=0;d<b.tableInfo.length;d++)for(var e=0;e<b.tableInfo[d].tables.length;e++)if(a===b.tableInfo[d].tables[e].tableID)return void(b.tableInfo[d].tables[e].tableStatus=c)}function h(a,c){for(var d=0;d<b.tableInfo.length;d++)for(var e=0;e<b.tableInfo[d].tables.length;e++)if(a===b.tableInfo[d].tables[e].tableID)return void(b.tableInfo[d].tables[e].tableMsg=c)}function i(a){for(var c=0;c<b.tableInfo.length;c++)for(var d=0;d<b.tableInfo[c].tables.length;d++)if(a===b.tableInfo[c].tables[d].tableID)return b.tableInfo[c].tables[d].tableNum}b.tableInfo=[{groupId:"xxx",groupName:"xxx",tables:[{tableNum:1,tableId:122,showFlag:!0},{tableNum:2,tableId:222,showFlag:!1},{tableNum:3,tableId:322,showFlag:!1},{tableNum:4,tableId:422,showFlag:!1},{tableNum:5,tableId:522,showFlag:!1},{tableNum:6,tableId:622,showFlag:!1},{tableNum:7,tableId:722,showFlag:!1},{tableNum:8,tableId:822,showFlag:!1}]},{groupId:"xxx",groupName:"xxx",tables:[{tableNum:1,tableId:122,showFlag:!0},{tableNum:2,tableId:222,showFlag:!1},{tableNum:3,tableId:322,showFlag:!1},{tableNum:4,tableId:422,showFlag:!1},{tableNum:5,tableId:522,showFlag:!1},{tableNum:6,tableId:622,showFlag:!1},{tableNum:7,tableId:722,showFlag:!1},{tableNum:8,tableId:822,showFlag:!1}]},{groupId:"xxx",groupName:"xxx",tables:[{tableNum:1,tableId:122,showFlag:!0},{tableNum:2,tableId:222,showFlag:!1},{tableNum:3,tableId:322,showFlag:!1},{tableNum:4,tableId:422,showFlag:!1},{tableNum:5,tableId:522,showFlag:!1},{tableNum:6,tableId:622,showFlag:!1},{tableNum:7,tableId:722,showFlag:!1},{tableNum:8,tableId:822,showFlag:!1}]}],b.tablemenu={},b.currentTableId="",b.currentTableName="",b.waitIdArrey=[],b.tablemsg=[],b.currentPrintMenu=[],c.get("/adyd/web/index!initTables.do?storeId="+a.accountId).success(function(a){"success"===a.flag?b.tableInfo=a.data:b.$emit("showmsg","初始化失败")}),b.opentable=function(a){c.post("/adyd/web/index!openTable.do?tableId="+a).success(function(c){"success"===c.flag&&(g(a,"1"),b.$emit("showmsg",c.why))})},b.closetable=function(a){b.getmenu(a)},b.printMenu=function(){if(null!==b.tablemenu.data&&void 0!==b.tablemenu.data&&"该桌位没有菜单"!==b.tablemenu.data[0].dishesName){var a=""+b.currentTableName+"\n";a+="订单号："+b.tablemenu.number+"\n";for(var c=0;c<b.tablemenu.data.length;c++)a+="￥"+b.tablemenu.data[c].price+"|"+b.tablemenu.data[c].dishesName+"	"+b.tablemenu.data[c].count+"份\n";a+="总价格：￥"+b.tablemenu.totalPrice,b.$emit("printmenuprice",a)}},b.$on("printpicAsk",function(a,d){1===d?c.post("/adyd/web/index!closeTable.do?tableId="+b.currentTableId).success(function(a){"success"===a.flag?(g(b.currentTableId,"2"),b.$emit("showmsg",a.why),b.tablemenu={}):b.$emit("showmsg",a.why)}):b.$emit("showmsg","打印不成功")}),b.getmenu=function(a){b.currentTableId=a,b.currentTableName=i(a),c.post("/adyd/web/index!getOrder.do?tableId="+a).success(function(a){angular.element("#myTab a:first").tab("show"),a.data?b.tablemenu=a.data:(b.$emit("showmsg",a.why),b.tablemenu={data:[{dishesId:"",dishesName:"该桌位没有菜单",price:"",count:""}],number:"",totalPrice:""})})},b.getmsg=function(a){b.currentTableId=a,b.currentTableName=i(a),c.post("/adyd/web/index!getMessage.do?tableId="+a).success(function(a){a.data?(b.tablemsg=a.data,angular.element("#myTab a:last").tab("show")):b.$emit("showmsg",a.why)})},b.delmsg=function(a,d){var e=[{id:a}];c.post("/adyd/web/index!delMessage.do?content="+JSON.stringify(e)).success(function(a){"success"===a.flag?(b.$emit("showmsg","删除成功"),b.tablemsg.splice(d,1),0===b.tablemsg.length&&h(b.currentTableId,!1)):b.$emit("showmsg","删除失败")})},b.clearmsgall=function(){var a=[];angular.forEach(b.tablemsg,function(a){this.push({id:a.id})},a),c.post("/adyd/web/index!delMessage.do?content="+JSON.stringify(a)).success(function(a){"success"===a.flag?(b.$emit("showmsg","全部清空成功"),b.tablemsg=[],h(b.currentTableId,!1)):b.$emit("showmsg","清空失败")})},d(),setTimeout(function(){e()},3e3),b.printMenupicFlag=0,b.printMenuFlag=0,b.$on("printmenuAsk",function(a,c){if(1===c){var d=[];angular.forEach(b.currentPrintMenu,function(a){this.push({id:a.id})},d),f(d)}setTimeout(function(){e()},3e3)}),b.menu={},b.$emit("summon","main"),angular.element("#myTab a").click(function(a){a.preventDefault(),angular.element(this).tab("show")})}]),angular.module("diancanApp").controller("AboutCtrl",["$rootScope","$scope","globalData",function(a,b,c){switch(c.getPara("subpage")){case"店铺宣传图":angular.element("#otherInfoTab a:first").tab("show");break;case"菜单管理":angular.element("#otherInfoTab li:eq(1) a").tab("show");break;case"餐桌设置":angular.element("#otherInfoTab li:eq(2) a").tab("show");break;case"订单轨迹":angular.element("#otherInfoTab a:last").tab("show")}angular.element("#otherInfoTab a").click(function(a){a.preventDefault(),angular.element(this).tab("show"),c.addPare("subpage",angular.element(this).context.text,"replace")})}]),angular.module("diancanApp").controller("menuCtrl",["$rootScope","$scope","$http",function(a,b,c){function d(){b.addgroup_=[],b.addmenu_=[],b.editgroup_={},b.editmenu_={},b.delgroup_=[],b.delmenu_=[],c.post("/adyd/web/dishes!showDishestypeAndDishes.do?storeId="+a.accountId).success(function(a){b.menudata=null===a||void 0===a?[]:a,b.menudatacopy=angular.copy(b.menudata)})}b.menudata=[],b.menudatacopy=[],d(),b.$emit("summon","set"),b.addFlag=!1,b.editFlag=!1,b.delFlag=!1,b.saveFlag=!1,b.tianjia=function(){b.addFlag=!0,b.editFlag=!1,b.delFlag=!1,b.saveFlag=!0},b.xiugai=function(){b.addFlag=!1,b.editFlag=!0,b.delFlag=!1,b.saveFlag=!0},b.shanchu=function(){b.addFlag=!1,b.editFlag=!1,b.delFlag=!0,b.saveFlag=!0},b.quxiao=function(){b.addFlag=!1,b.editFlag=!1,b.delFlag=!1,b.saveFlag=!1,b.menudata=angular.copy(b.menudatacopy),b.addgroup_=[],b.addmenu_=[],b.editgroup_={},b.editmenu_={},b.delgroup_=[],b.delmenu_=[]},b.baocun=function(){if(b.addFlag===!0)c.post("/adyd/web/dishes!addDishestypeAndDishes.do?postdata="+JSON.stringify(b.addgroup_)+"&storeId="+a.accountId+"&postdata1="+JSON.stringify(b.addmenu_)).success(function(a){"success"===a.flag?(b.addFlag=!1,b.editFlag=!1,b.delFlag=!1,b.saveFlag=!1,d()):b.$emit("showmsg","操作出错")});else if(b.delFlag===!0)c.post("/adyd/web/dishes!deleteDishestypeAndDishes.do?postdata="+JSON.stringify(b.delgroup_)+"&postdata1="+JSON.stringify(b.delmenu_)).success(function(a){"success"===a.flag?(b.addFlag=!1,b.editFlag=!1,b.delFlag=!1,b.saveFlag=!1,d()):b.$emit("showmsg","操作出错")});else if(b.editFlag===!0){var e=[],f=[];angular.forEach(b.editmenu_,function(a){this.push(a)},e),angular.forEach(b.editgroup_,function(a){this.push(a)},f),c.post("/adyd/web/dishes!updateDishestypeAndDishes.do?postdata="+JSON.stringify(f)+"&postdata1="+JSON.stringify(e)).success(function(a){"success"===a.flag?(b.addFlag=!1,b.editFlag=!1,b.delFlag=!1,b.saveFlag=!1,d()):b.$emit("showmsg","操作出错")})}},b.addgroup_=[],b.addmenu_=[],b.editgroup_={},b.editmenu_={},b.delgroup_=[],b.delmenu_=[],b.delgronp=function(a){b.delgroup_.push({groupId:b.menudata[a].grunpId}),b.menudata.splice(a,1)},b.delmenu=function(a,c){b.delmenu_.push({groupId:b.menudata[a].grunpId,theId:b.menudata[a].grunpMenu[c].theId}),b.menudata[a].grunpMenu.splice(c,1)},b.addgroup=function(){var a={grunpName:"",grunpId:"add",grunpMenu:[]};b.addgroup_.push(a),b.menudata.push(b.addgroup_[b.addgroup_.length-1])},b.addmenus=function(a){var c={grunpId:b.menudata[a].grunpId,data:{price:"",theName:"",theId:"add"}};"add"===c.grunpId?b.menudata[a].grunpMenu.push(c.data):(b.addmenu_.push(c),b.menudata[a].grunpMenu.push(b.addmenu_[b.addmenu_.length-1].data))},b.groupedited=function(a){"add"!==b.menudata[a].grunpId&&(b.editgroup_[a]={grunpId:b.menudata[a].grunpId,grunpName:b.menudata[a].grunpName})},b.menuedited=function(a,c){return void 0===b.menudata[a].grunpMenu[c].price||null===b.menudata[a].grunpMenu[c].price?(b.$emit("showmsg","请输入数字"),b.editmenu_[""+a+c]=void 0,void(b.menudata[a].grunpMenu[c].price=angular.copy(b.menudatacopy[a].grunpMenu[c].price))):void("add"!==b.menudata[a].grunpMenu[c].theId&&void 0===b.editmenu_[""+a+c]&&(b.editmenu_[""+a+c]={grunpId:b.menudata[a].grunpId,data:b.menudata[a].grunpMenu[c]}))}}]),angular.module("diancanApp").controller("tableCtrl",["$rootScope","$scope","$http",function(a,b,c){function d(){b.addgroup_=[],b.addmenu_=[],b.editgroup_={},b.editmenu_={},b.delgroup_=[],b.delmenu_=[],c.post("/adyd/web/tble!showTableAndTablePos.do?storeId="+a.accountId).success(function(a){b.menudata=null===a||void 0===a?[]:a,b.menudatacopy=angular.copy(b.menudata)})}b.showCodeImg=!1,b.menudata=[],b.menudatacopy=[],b.showCodeImgfn=function(){b.showCodeImg=!b.showCodeImg},d(),b.$emit("summon","set"),b.addFlag=!1,b.editFlag=!1,b.delFlag=!1,b.saveFlag=!1,b.tianjia=function(){b.addFlag=!0,b.editFlag=!1,b.delFlag=!1,b.saveFlag=!0},b.xiugai=function(){b.addFlag=!1,b.editFlag=!0,b.delFlag=!1,b.saveFlag=!0},b.shanchu=function(){b.addFlag=!1,b.editFlag=!1,b.delFlag=!0,b.saveFlag=!0},b.quxiao=function(){b.addFlag=!1,b.editFlag=!1,b.delFlag=!1,b.saveFlag=!1,b.menudata=angular.copy(b.menudatacopy),b.addgroup_=[],b.addmenu_=[],b.editgroup_={},b.editmenu_={},b.delgroup_=[],b.delmenu_=[]},b.baocun=function(){if(b.addFlag===!0)c.post("/adyd/web/tble!addTableAndTablePos.do?postdata="+JSON.stringify(b.addgroup_)+"&storeId="+a.accountId+"&postdata1="+JSON.stringify(b.addmenu_)).success(function(a){"success"===a.flag?(b.addFlag=!1,b.editFlag=!1,b.delFlag=!1,b.saveFlag=!1,d()):b.$emit("showmsg","操作出错")});else if(b.delFlag===!0)c.post("/adyd/web/tble!deleteTableAndTablePos.do?postdata="+JSON.stringify(b.delgroup_)+"&postdata1="+JSON.stringify(b.delmenu_)).success(function(a){"success"===a.flag?(b.addFlag=!1,b.editFlag=!1,b.delFlag=!1,b.saveFlag=!1,d()):b.$emit("showmsg","操作出错")});else if(b.editFlag===!0){var e=[],f=[];angular.forEach(b.editmenu_,function(a){this.push(a)},e),angular.forEach(b.editgroup_,function(a){this.push(a)},f),c.post("/adyd/web/tble!updateTableAndTablePos.do?postdata="+JSON.stringify(f)+"&postdata1="+JSON.stringify(e)).success(function(a){"success"===a.flag?(b.addFlag=!1,b.editFlag=!1,b.delFlag=!1,b.saveFlag=!1,d()):b.$emit("showmsg","操作出错")})}},b.addgroup_=[],b.addmenu_=[],b.editgroup_={},b.editmenu_={},b.delgroup_=[],b.delmenu_=[],b.delgronp=function(a){b.delgroup_.push({groupId:b.menudata[a].grunpId}),b.menudata.splice(a,1)},b.delmenu=function(a,c){b.delmenu_.push({groupId:b.menudata[a].grunpId,theId:b.menudata[a].grunpMenu[c].theId}),b.menudata[a].grunpMenu.splice(c,1)},b.addgroup=function(){var a={grunpName:"",grunpId:"add",grunpMenu:[]};b.addgroup_.push(a),b.menudata.push(b.addgroup_[b.addgroup_.length-1])},b.addmenus=function(a){var c={grunpId:b.menudata[a].grunpId,data:{theName:"",theId:"add"}};"add"===c.grunpId?b.menudata[a].grunpMenu.push(c.data):(b.addmenu_.push(c),b.menudata[a].grunpMenu.push(b.addmenu_[b.addmenu_.length-1].data))},b.groupedited=function(a){"add"!==b.menudata[a].grunpId&&(b.editgroup_[a]={grunpId:b.menudata[a].grunpId,grunpName:b.menudata[a].grunpName})},b.menuedited=function(a,c){"add"!==b.menudata[a].grunpMenu[c].theId&&void 0===b.editmenu_[""+a+c]&&(b.editmenu_[""+a+c]={grunpId:b.menudata[a].grunpId,data:b.menudata[a].grunpMenu[c]})}}]),angular.module("diancanApp").directive("fileUploader",function(){return{restrict:"E",transclude:!0,template:'<div><input type="file" multiple /><button>上传</button></div>',controller:["$scope","$element","$fileUpload",function(a,b,c){a.notReady=!0,a.files=[],a.upload=function(){c.upload(a.files)};var d=b.find('input[type="file"]');d.bind("change",function(b){if(a.notReady=0===b.target.files.length,b.target.files.length>4)return void a.$emit("showmsg","请最多只选择4张图片！");for(var c in b.target.files)if("object"==typeof b.target.files[c]){if(!/\.(gif|jpg|jpeg|png|GIF|JPG|PNG)$/.test(b.target.files[c].name)){a.$emit("showmsg","图片类型必须是.gif,jpeg,jpg,png中的一种！"),a.files=[],b.target=null;break}a.files.push(b.target.files[c])}})}]}}),angular.module("diancanApp").service("$fileUpload",["$http",function(a){this.upload=function(b){var c=new FormData;for(var d in b)c.append("file_"+d,b[d]);a({method:"POST",url:"/api/files",data:c,headers:{"Content-Type":void 0},transformRequest:angular.identity}).success(function(a){console.log(a)})}}]),angular.module("diancanApp").factory("globalData",function(){function a(a,b,c){return void 0!==d[a]&&"replace"!==c?!1:(d[a]=b,d[a])}function b(a,b){return void 0===d[a]?!1:void(d[a]=b)}function c(a){return d[a]}var d={};return{addPare:a,getPara:c,replacePara:b}}),angular.module("diancanApp").controller("loginCtrl",["$scope",function(a){a.$emit("summon","login"),a.name="",a.password="",a.loginGo=function(){return""===a.name||null===a.name||void 0===a.name||""===a.password||null===a.password||void 0===a.password?void a.$emit("showmsg","请填写正确的用户名与密码"):void a.$emit("logindata",{account:a.name,password:a.password})}}]);